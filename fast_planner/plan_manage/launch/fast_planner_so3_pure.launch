<launch>
  <!-- ===================================== Arguments ===================================== -->
  <!-- Flight type: 1 = 2D Nav Goal, 2 = waypoints -->
  <arg name="flight_type" default="1"/>

  <!-- Map size -->
  <arg name="map_size_x" default="40.0"/>
  <arg name="map_size_y" default="20.0"/>
  <arg name="map_size_z" default="5.0"/>

  <!-- Initial position -->
  <arg name="init_x" default="-19.0"/>
  <arg name="init_y" default="0.0"/>
  <arg name="init_z" default="1.0"/>

  <!-- Camera intrinsics (90-degree FOV) -->
  <arg name="cx" default="320.0"/>
  <arg name="cy" default="240.0"/>
  <arg name="fx" default="320.0"/>
  <arg name="fy" default="320.0"/>

  <!-- Dynamics -->
  <arg name="max_vel" default="2.5"/>
  <arg name="max_acc" default="2.5"/>

  <!-- ==================== 1. Random Map (障礙物地圖) ==================== -->
  <node pkg="map_generator" name="random_forest" type="random_forest" output="screen">
    <param name="map/x_size" value="$(arg map_size_x)"/>
    <param name="map/y_size" value="$(arg map_size_y)"/>
    <param name="map/z_size" value="$(arg map_size_z)"/>
    <param name="map/resolution" value="0.1"/>

    <param name="ObstacleShape/seed" value="1"/>
    <param name="map/obs_num" value="100"/>
    <param name="ObstacleShape/lower_rad" value="0.5"/>
    <param name="ObstacleShape/upper_rad" value="0.7"/>
    <param name="ObstacleShape/lower_hei" value="0.0"/>
    <param name="ObstacleShape/upper_hei" value="3.0"/>

    <param name="sensing/radius" value="5.0"/>
    <param name="sensing/rate" value="10.0"/>
  </node>

  <!-- ==================== 2. SO3 Quadrotor Simulator ==================== -->
  <node pkg="so3_quadrotor_simulator"
        type="quadrotor_simulator_so3"
        name="quadrotor_simulator_so3"
        output="screen">
    <param name="rate/odom" value="100.0"/>
    <param name="simulator/init_state_x" value="$(arg init_x)"/>
    <param name="simulator/init_state_y" value="$(arg init_y)"/>
    <param name="simulator/init_state_z" value="$(arg init_z)"/>
    <remap from="~odom" to="/visual_slam/odom"/>
    <remap from="~cmd" to="so3_cmd"/>
    <remap from="~imu" to="/sim/imu"/>
  </node>

  <!-- ==================== 3. SO3 Controller ==================== -->
  <node pkg="nodelet"
        type="nodelet"
        args="standalone so3_control/SO3ControlNodelet"
        name="so3_control"
        required="true"
        output="screen">
    <remap from="~odom" to="/state_ukf/odom"/>
    <remap from="~position_cmd" to="/planning/pos_cmd"/>
    <remap from="~so3_cmd" to="so3_cmd"/>
    <remap from="~imu" to="/sim/imu"/>
    <rosparam file="$(find so3_control)/config/gains.yaml"/>
    <rosparam file="$(find so3_control)/config/corrections_hummingbird.yaml"/>
    <param name="mass" value="0.98"/>
    <param name="use_angle_corrections" value="false"/>
    <param name="use_external_yaw" value="false"/>
  </node>

  <!-- ==================== 4. State Estimation (Use odom as truth) ==================== -->
  <node pkg="topic_tools" type="relay" name="relay_ukf"
        args="/visual_slam/odom /state_ukf/odom"/>

  <!-- Broadcast TF from odometry for RViz visualization -->
  <node pkg="plan_manage" type="odom_to_tf.py" name="odom_to_tf" output="screen"/>

  <!-- ==================== 5. Local Sensing (Depth Camera Simulation) ==================== -->
  <node pkg="local_sensing_node" type="pcl_render_node" name="pcl_render_node" output="screen">
    <rosparam command="load" file="$(find local_sensing_node)/params/camera.yaml"/>
    <param name="sensing_horizon" value="5.0"/>
    <param name="sensing_rate" value="30.0"/>
    <param name="estimation_rate" value="30.0"/>

    <param name="map/x_size" value="$(arg map_size_x)"/>
    <param name="map/y_size" value="$(arg map_size_y)"/>
    <param name="map/z_size" value="$(arg map_size_z)"/>

    <remap from="~global_map" to="/map_generator/global_cloud"/>
    <remap from="~odometry" to="/visual_slam/odom"/>
    <remap from="~pcl_render_node/cloud" to="/camera/depth/points"/>
    <remap from="~pcl_render_node/depth" to="/camera/depth/image_raw"/>
    <remap from="~pcl_render_node/pose" to="/camera/pose"/>
  </node>

  <!-- ==================== 6. Trajectory Server (Publishes position commands) ==================== -->
  <node pkg="plan_manage" name="traj_server" type="traj_server" output="screen">
    <remap from="/position_cmd" to="/planning/pos_cmd"/>
    <remap from="/odom_world" to="/visual_slam/odom"/>
    <param name="traj_server/time_forward" value="1.5" type="double"/>
  </node>

  <!-- ==================== 7. Waypoint Generator (Converts RViz 2D Nav Goal) ==================== -->
  <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator" output="screen">
    <remap from="~odom" to="/visual_slam/odom"/>
    <remap from="~goal" to="/move_base_simple/goal"/>
    <remap from="~traj_start_trigger" to="/traj_start_trigger"/>
    <param name="waypoint_type" value="manual-lonely-waypoint" type="string"/>
  </node>

  <!-- ==================== 8. Fast-Planner Algorithm ==================== -->
  <include file="$(find plan_manage)/launch/kino_algorithm_hector.xml">
    <arg name="map_size_x_" value="$(arg map_size_x)"/>
    <arg name="map_size_y_" value="$(arg map_size_y)"/>
    <arg name="map_size_z_" value="$(arg map_size_z)"/>
    <arg name="odometry_topic" value="/visual_slam/odom"/>
    <arg name="camera_pose_topic" value="/visual_slam/odom"/>
    <arg name="depth_topic" value="/camera/depth/image_raw"/>
    <arg name="cloud_topic" value="/camera/depth/points"/>
    <arg name="cx" value="$(arg cx)"/>
    <arg name="cy" value="$(arg cy)"/>
    <arg name="fx" value="$(arg fx)"/>
    <arg name="fy" value="$(arg fy)"/>
    <arg name="max_vel" value="$(arg max_vel)"/>
    <arg name="max_acc" value="$(arg max_acc)"/>
    <arg name="flight_type" value="$(arg flight_type)"/>

    <!-- Waypoint parameters (required but not used in 2D Nav Goal mode) -->
    <arg name="point_num" value="1"/>
    <arg name="point0_x" value="0.0"/>
    <arg name="point0_y" value="0.0"/>
    <arg name="point0_z" value="1.0"/>
    <arg name="point1_x" value="0.0"/>
    <arg name="point1_y" value="0.0"/>
    <arg name="point1_z" value="1.0"/>
    <arg name="point2_x" value="0.0"/>
    <arg name="point2_y" value="0.0"/>
    <arg name="point2_z" value="1.0"/>
  </include>

  <!-- ==================== 9. RViz Visualization ==================== -->
  <node type="rviz" name="rviz" pkg="rviz" output="screen"
        args="-d $(find plan_manage)/config/kino.rviz"/>

</launch>
