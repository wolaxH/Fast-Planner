<?xml version="1.0"?>
<launch>
  <!-- ========== Arguments ========== -->
  <arg name="map_size_x" default="40.0"/>  <!-- 增大地圖範圍 [-20, 20] -->
  <arg name="map_size_y" default="40.0"/>  <!-- 增大地圖範圍 [-20, 20] -->
  <arg name="map_size_z" default="5.0"/>

  <!-- Initial position -->
  <arg name="init_x" default="0.0"/>
  <arg name="init_y" default="0.0"/>
  <arg name="init_z" default="1.0"/>  <!-- 起飛高度，需要高於障礙物膨脹範圍 -->

  <!-- Dynamic limits (conservative for Hector) -->
  <arg name="max_vel" default="1.0"/>
  <arg name="max_acc" default="1.0"/>

  <!-- Hector Kinect camera intrinsics (from URDF: 60 degree FOV, 640x480) -->
  <!-- fx = fy = width / (2 * tan(fov/2)) = 640 / (2 * tan(30)) = 554.26 -->
  <arg name="cx" default="320.0"/>
  <arg name="cy" default="240.0"/>
  <arg name="fx" default="554.26"/>
  <arg name="fy" default="554.26"/>

  <!-- Flight mode: 1=2D Nav Goal, 2=Waypoints -->
  <arg name="flight_type" default="1"/>

  <!-- Waypoints (if flight_type=2) -->
  <arg name="point_num" default="1"/>
  <arg name="point0_x" default="5.0"/>
  <arg name="point0_y" default="0.0"/>
  <arg name="point0_z" default="1.0"/>
  <arg name="point1_x" default="0.0"/>
  <arg name="point1_y" default="0.0"/>
  <arg name="point1_z" default="1.0"/>
  <arg name="point2_x" default="0.0"/>
  <arg name="point2_y" default="0.0"/>
  <arg name="point2_z" default="1.0"/>

  <!-- ========== 1. Gazebo World ========== -->
  <include file="$(find gazebo_ros)/launch/empty_world.launch">
    <arg name="world_name" value="$(find plan_manage)/worlds/fast_planner_obstacles.world"/>
    <arg name="paused" value="false"/>
    <arg name="gui" value="true"/>
  </include>

  <!-- ========== 2. Hector Quadrotor with Kinect ========== -->
  <include file="$(find hector_quadrotor_gazebo)/launch/spawn_quadrotor_with_kinect.launch">
    <arg name="x" value="$(arg init_x)"/>
    <arg name="y" value="$(arg init_y)"/>
    <arg name="z" value="$(arg init_z)"/>
    <arg name="use_ground_truth_for_tf" value="true"/>
    <arg name="use_ground_truth_for_control" value="true"/>
  </include>

  <!-- ========== 3. Fast-Planner Algorithm ========== -->
  <include file="$(find plan_manage)/launch/kino_algorithm_hector.xml">
    <arg name="map_size_x_" value="$(arg map_size_x)"/>
    <arg name="map_size_y_" value="$(arg map_size_y)"/>
    <arg name="map_size_z_" value="$(arg map_size_z)"/>

    <!-- Hector topics (pose_type=2 uses odometry topic for depth callback) -->
    <arg name="odometry_topic" value="/ground_truth/state"/>
    <arg name="depth_topic" value="/camera/depth/image_raw"/>
    <arg name="cloud_topic" value="/camera/depth/points"/>

    <!-- Camera intrinsics -->
    <arg name="cx" value="$(arg cx)"/>
    <arg name="cy" value="$(arg cy)"/>
    <arg name="fx" value="$(arg fx)"/>
    <arg name="fy" value="$(arg fy)"/>

    <!-- Dynamic limits -->
    <arg name="max_vel" value="$(arg max_vel)"/>
    <arg name="max_acc" value="$(arg max_acc)"/>

    <!-- Flight configuration -->
    <arg name="flight_type" value="$(arg flight_type)"/>
    <arg name="point_num" value="$(arg point_num)"/>
    <arg name="point0_x" value="$(arg point0_x)"/>
    <arg name="point0_y" value="$(arg point0_y)"/>
    <arg name="point0_z" value="$(arg point0_z)"/>
    <arg name="point1_x" value="$(arg point1_x)"/>
    <arg name="point1_y" value="$(arg point1_y)"/>
    <arg name="point1_z" value="$(arg point1_z)"/>
    <arg name="point2_x" value="$(arg point2_x)"/>
    <arg name="point2_y" value="$(arg point2_y)"/>
    <arg name="point2_z" value="$(arg point2_z)"/>
  </include>

  <!-- ========== 4. Waypoint Generator (converts RViz 2D Nav Goal) ========== -->
  <node pkg="waypoint_generator" name="waypoint_generator" type="waypoint_generator" output="screen">
    <remap from="~odom" to="/ground_truth/state"/>
    <remap from="~goal" to="/move_base_simple/goal"/>
    <param name="waypoint_type" value="manual-lonely-waypoint"/>
  </node>

  <!-- ========== 5. Trajectory Server ========== -->
  <node pkg="plan_manage" name="traj_server" type="traj_server" output="screen"/>

  <!-- ========== 6. Command Bridge (Fast-Planner -> Hector) ========== -->
  <!-- 使用速度控制模式，精確跟蹤軌跡 -->
  <node pkg="plan_manage" name="hector_cmd_bridge" type="hector_cmd_bridge" output="screen">
    <param name="max_linear_vel" value="$(arg max_vel)"/>
    <param name="max_angular_vel" value="1.5"/>
    <param name="position_gain" value="1.0"/>   <!-- Kp: 位置誤差增益 -->
    <param name="velocity_gain" value="1.0"/>   <!-- Kv: 速度前饋增益 (提高以更好跟蹤軌跡) -->
  </node>

  <!-- Note: Hector already publishes TF via ground_truth_to_tf -->

  <!-- ========== 7. RViz ========== -->
  <node type="rviz" name="rviz" pkg="rviz"
        args="-d $(find plan_manage)/config/kino.rviz" output="screen"/>
</launch>
