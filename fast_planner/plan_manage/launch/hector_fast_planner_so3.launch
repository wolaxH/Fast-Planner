<launch>
  <!-- ===================================== Arguments ===================================== -->
  <!-- Flight type: 1 = 2D Nav Goal, 2 = waypoints -->
  <arg name="flight_type" default="1"/>

  <!-- Map size -->
  <arg name="map_size_x" default="40.0"/>
  <arg name="map_size_y" default="20.0"/>
  <arg name="map_size_z" default="5.0"/>

  <!-- Initial position -->
  <arg name="init_x" default="-19.0"/>
  <arg name="init_y" default="0.0"/>
  <arg name="init_z" default="1.0"/>

  <!-- Camera intrinsics (90-degree FOV) -->
  <arg name="cx" default="320.0"/>
  <arg name="cy" default="240.0"/>
  <arg name="fx" default="320.0"/>
  <arg name="fy" default="320.0"/>

  <!-- Dynamics - moderate for SO3 controller -->
  <arg name="max_vel" default="2.0"/>
  <arg name="max_acc" default="2.0"/>

  <!-- ==================== 1. Gazebo World ==================== -->
  <include file="$(find plan_manage)/worlds/test_hector_world.launch">
    <arg name="gui" value="true"/>
  </include>

  <!-- ==================== 2. Spawn Quadrotor ==================== -->
  <param name="robot_description"
         command="$(find xacro)/xacro '$(find plan_manage)/urdf/hector_with_depth.urdf.xacro'" />

  <node pkg="gazebo_ros" type="spawn_model" name="spawn_quadrotor"
        args="-urdf -param robot_description -model quadrotor
              -x $(arg init_x) -y $(arg init_y) -z $(arg init_z)"
        output="screen"/>

  <node pkg="robot_state_publisher" type="robot_state_publisher" name="robot_state_publisher">
    <param name="publish_frequency" value="50.0"/>
  </node>

  <node pkg="joint_state_publisher" type="joint_state_publisher" name="joint_state_publisher"/>

  <!-- ==================== 3. SO3 Quadrotor Simulator ==================== -->
  <node pkg="so3_quadrotor_simulator"
        type="quadrotor_simulator_so3"
        name="quadrotor_simulator_so3"
        output="screen">
    <param name="rate/odom" value="100.0"/>
    <param name="simulator/init_state_x" value="$(arg init_x)"/>
    <param name="simulator/init_state_y" value="$(arg init_y)"/>
    <param name="simulator/init_state_z" value="$(arg init_z)"/>
    <remap from="~odom" to="/visual_slam/odom"/>
    <remap from="~cmd" to="so3_cmd"/>
    <remap from="~imu" to="/sim/imu"/>
    <remap from="~force_disturbance" to="force_disturbance"/>
    <remap from="~moment_disturbance" to="moment_disturbance"/>
  </node>

  <!-- ==================== 4. SO3 Controller ==================== -->
  <node pkg="nodelet"
        type="nodelet"
        args="standalone so3_control/SO3ControlNodelet"
        name="so3_control"
        required="true"
        output="screen">
    <remap from="~odom" to="/state_ukf/odom"/>
    <remap from="~position_cmd" to="/planning/pos_cmd"/>  <!-- Connect to Fast-Planner -->
    <remap from="~motors" to="motors"/>
    <remap from="~corrections" to="corrections"/>
    <remap from="~so3_cmd" to="so3_cmd"/>
    <remap from="~imu" to="/sim/imu"/>
    <rosparam file="$(find so3_control)/config/gains.yaml"/>
    <rosparam file="$(find so3_control)/config/corrections_hummingbird.yaml"/>
    <param name="mass" value="1.5"/>  <!-- Adjusted for Hector mass -->
    <param name="use_angle_corrections" value="false"/>
    <param name="use_external_yaw" value="false"/>
    <param name="gains/rot/z" value="1.0"/>
    <param name="gains/ang/z" value="0.1"/>
  </node>

  <!-- ==================== 5. Odom & State Estimation (Simplified) ==================== -->
  <!-- Use ground truth as visual SLAM -->
  <node pkg="topic_tools" type="relay" name="relay_odom"
        args="/ground_truth/state /visual_slam/odom"/>

  <!-- Fake UKF - just relay odom -->
  <node pkg="topic_tools" type="relay" name="relay_ukf"
        args="/ground_truth/state /state_ukf/odom"/>

  <!-- ==================== 6. Auto-Enable Motors ==================== -->
  <node pkg="fast_planner_bridge" type="enable_motors.sh"
        name="enable_motors" output="screen"
        launch-prefix="bash -c 'sleep 3; $0 $@'" />

  <!-- ==================== 7. Fast-Planner Algorithm ==================== -->
  <include file="$(find plan_manage)/launch/kino_algorithm_hector.xml">
    <arg name="map_size_x_" value="$(arg map_size_x)"/>
    <arg name="map_size_y_" value="$(arg map_size_y)"/>
    <arg name="map_size_z_" value="$(arg map_size_z)"/>
    <arg name="odometry_topic" value="/ground_truth/state"/>
    <arg name="camera_pose_topic" value="/ground_truth/state"/>
    <arg name="depth_topic" value="/camera/depth/image_raw"/>
    <arg name="cloud_topic" value="/camera/depth/points"/>
    <arg name="cx" value="$(arg cx)"/>
    <arg name="cy" value="$(arg cy)"/>
    <arg name="fx" value="$(arg fx)"/>
    <arg name="fy" value="$(arg fy)"/>
    <arg name="max_vel" value="$(arg max_vel)"/>
    <arg name="max_acc" value="$(arg max_acc)"/>
    <arg name="flight_type" value="$(arg flight_type)"/>
  </include>

  <!-- ==================== 8. RViz Visualization ==================== -->
  <node type="rviz" name="rviz" pkg="rviz" output="screen"
        args="-d $(find plan_manage)/config/hector_fast_planner.rviz"/>

</launch>
